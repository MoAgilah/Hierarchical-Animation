#include "MeshComponent.h"

MeshComponent::MeshComponent(XMFLOAT3 pos, XMFLOAT3 rot, string hName, string mName)
{
	worldMat = XMMatrixIdentity();
	localRot = XMFLOAT4(rot.x, rot.y, rot.z, 0.0f);
	localPos = XMFLOAT4(pos.x, pos.y, pos.z, 0.0f);
	name = mName;
	if (name != "root")
	{
		string path = "Resources/" + hName + "/" + mName + ".x";
		mesh = CommonMesh::LoadFromXFile(Application::s_pApp, path.c_str());
	}
	else{ mesh = nullptr; }
}

MeshComponent::~MeshComponent()
{
	DeleteChildren();
	delete GetMesh();
}


void MeshComponent::AddChild(MeshComponent* child)
{
	children.push_back(child);
}

XMFLOAT4& MeshComponent::GetLocPos()
{
	return localPos;
}

XMFLOAT4& MeshComponent::GetLocRot()
{
	return localRot;
}

XMMATRIX& MeshComponent::GetWorld()
{
	return worldMat;
}

bool MeshComponent::GetHasChild(void)
{
	return children.empty();
}

CommonMesh* MeshComponent::GetMesh()
{
	return mesh;
}

string MeshComponent::GetName()
{
	return name;
}

void MeshComponent::updateMat(void)
{
	XMVECTOR pVec;
	XMMATRIX mRotX, mRotY, mRotZ, mTrans;

	mRotX = XMMatrixRotationX(XMConvertToRadians(GetLocRot().x));
	mRotY = XMMatrixRotationY(XMConvertToRadians(GetLocRot().y));
	mRotZ = XMMatrixRotationZ(XMConvertToRadians(GetLocRot().z));

	pVec = XMLoadFloat4(&GetLocPos());

	mTrans = XMMatrixTranslationFromVector(pVec);

	worldMat = mRotX * mRotZ *mRotY * mTrans;

	if (!children.empty())
	{
		updateChildMat();
	}
}

void MeshComponent::updateChildMat(void)
{
	XMVECTOR pVec;
	XMMATRIX mRotX, mRotY, mRotZ, mTrans;
	XMMATRIX world;

	for (int i = 0; i < children.size(); ++i)
	{
		mRotX = XMMatrixRotationX(XMConvertToRadians(children[i]->GetLocRot().x));
		mRotY = XMMatrixRotationY(XMConvertToRadians(children[i]->GetLocRot().y));
		mRotZ = XMMatrixRotationZ(XMConvertToRadians(children[i]->GetLocRot().z));

		pVec = XMLoadFloat4(&children[i]->GetLocPos());

		mTrans = XMMatrixTranslationFromVector(pVec);
		
		children[i]->GetWorld() = mRotX * mRotZ *mRotY * mTrans * GetWorld();

		if (!children[i]->GetHasChild())
		{
			children[i]->updateChildMat();
		}
	}
}

void MeshComponent::Draw()
{
	Application::s_pApp->SetWorldMatrix(GetWorld());
	if (mesh != nullptr)
	{
		mesh->Draw();
	}

	if (!children.empty())
	{
		for (int i = 0; i < children.size(); ++i)
		{
			children[i]->Draw();
		}
	}
}

void MeshComponent::DeleteChildren()
{
	for (int i = 0; i < children.size(); ++i)
	{
		if (children[i]->GetHasChild())
		{
			children[i]->DeleteChildren();
		}

		delete children[i];
		children[i] = nullptr;
	}
}