#include "Robot.h"

Hiearchy* Robot::s_Hiearchie = NULL;

bool Robot::s_bResourcesReady = false;

AnimationController* Robot::aControl = nullptr;

Robot::Robot(const XMFLOAT3& pos, const XMFLOAT3& rot, const double& scalar)
	:scaleF(scalar)
{
	s_Hiearchie = new Hiearchy("Robot", "rHierarchy.txt", pos, rot, scaleF);

	aControl = new AnimationController(pos, rot, scaleF);

	m_mCamWorldMatrix = XMMatrixIdentity();

	m_v4CamOff = XMFLOAT4(0.5, 12.0f, 50.0f, 0.0f);
	m_v4CamRot = XMFLOAT4(0.0f, 0.0f, 0.0f, 0.0f);

	m_vCamWorldPos = XMVectorZero();
	m_vForwardVector = XMVectorZero();

	m_fSpeed = 0.0f;

	m_bRobCam = false;
}

Robot::~Robot()
{
	delete s_Hiearchie;
}

void Robot::CreateHierarchie(void)
{
	s_Hiearchie->LoadFromFile();
}

void Robot::LoadAnimations()
{
	aControl->LoadAnimation(s_Hiearchie->GetHierarchy(), "Robot", "Idle", scaleF);
	aControl->LoadAnimation(s_Hiearchie->GetHierarchy(), "Robot", "Attack", scaleF);
	aControl->LoadAnimation(s_Hiearchie->GetHierarchy(), "Robot", "Die", scaleF, false);
}

void Robot::Update(bool bPlayerContol, const float& deltatime)
{
	s_Hiearchie->GetRoot()->updateMat();
	if (bPlayerContol)
	{
		if (Application::s_pApp->IsKeyPressed('1'))
		{
			if (!aControl->GetIsActive("Idle"))
			{
				aControl->ChangeTrack("Idle");
			}
		}

		if (Application::s_pApp->IsKeyPressed('2'))
		{
			if (!aControl->GetIsActive("Attack"))
			{
				aControl->ChangeTrack("Attack");
			}
		}

		if (Application::s_pApp->IsKeyPressed('3'))
		{
			if (!aControl->GetIsActive("Die"))
			{
				aControl->ChangeTrack("Die");
			}
		}
	}
	
	
	aControl->AdvanceTime(deltatime, s_Hiearchie->GetHierarchy());
	
	
}

void Robot::Draw(void)
{
	s_Hiearchie->GetRoot()->Draw();
}

void Robot::SetWorldPosition(float fX, float fY, float fZ)
{
	s_Hiearchie->GetRoot()->GetLocPos() = XMFLOAT4(fX, fY, fZ, 0.0f);
	s_Hiearchie->GetRoot()->updateMat();
}

void Robot::UpdateMatrices(void)
{
	XMVECTOR pVec;
	XMMATRIX mRotY, mTrans;

	s_Hiearchie->GetRoot()->updateMat();

	mRotY = XMMatrixRotationY(XMConvertToRadians(s_Hiearchie->GetRoot()->GetLocRot().y));
	pVec = XMLoadFloat4(&s_Hiearchie->GetRoot()->GetLocPos());

	mTrans = XMMatrixTranslationFromVector(pVec);

	pVec = XMLoadFloat4(&m_v4CamOff);
	m_mCamWorldMatrix = XMMatrixTranslationFromVector(pVec) * mRotY * mTrans;

	// Get the camera's world position (m_vCamWorldPos) out of m_mCameraWorldMatrix
	m_vCamWorldPos = XMVectorZero();
	m_vCamWorldPos = XMVector3Transform(m_vCamWorldPos, m_mCamWorldMatrix);
}